# ADR 008: 분산락 제거 및 DB 제약 조건을 활용한 동시성 제어

DATE: 2025.12.18

## 상태 (Status)

Superseded (이전의 분산락 도입 결정을 대체함)

## 맥락 (Context)

기존에는 동시성 제어를 위해 Redis 분산락(Redisson)을 사용했으나, 락 획득/해제 과정에서의 네트워크 오버헤드가 성능 병목으로 작용했다. 
이미 Redis 재고 관리와 Kafka를 통해 트래픽이 제어되고 있으므로, 더 경량화된 중복 방지책이 필요하다.

## 결정 (Decision)

아키텍처 단순화와 성능 최적화를 위해 분산락을 제거한다.

1. 분산락 제거 및 DB Unique Index 활용
   - 성능 저하의 주원인인 분산락 로직을 제거한다.
   - 대신 `issued_coupons` 테이블의 `(user_id, coupon_id)` 유니크 인덱스를 통해 1인 1쿠폰 정책을 DB 레벨에서 물리적으로 보장한다.

2. 예외 처리 전략:
   - Kafka Consumer가 동시에 같은 유저의 요청을 처리하더라도, DB INSERT 시점에 먼저 도달한 트랜잭션만 성공하고, 나머지는 `DataIntegrityViolationException`이 발생한다.
   - 해당 예외를 catch하여 비즈니스 로직상 "이미 발급된 쿠폰입니다"와 같은 메시지로 처리하고 조용히 무시한다.

## 결과 (Consequences)

긍정적 효과 (Pros)
- 데이터 무결성의 최후 보루: 어떤 우회 경로로 요청이 들어오더라도 DB 레벨에서 물리적으로 중복을 막으므로 가장 강력한 정합성을 보장한다.
- 성능 및 복잡도 최적화: 별도의 락을 잡기 위한 네트워크 통신이 불필요하며, 코드가 매우 간결해진다.

부정적 효과 및 트레이드오프 (Cons)
- 예외 의존적 흐름: 정상적인 흐름 제어가 아닌 예외를 통해 비즈니스 로직을 제어하게 되므로, 로그 레벨 관리 등에 주의가 필요하다.
- 확장적 제약: DB의 Insert 성능에 의존하므로, 극단적으로 높은 쓰기 부하가 발생할 경우 샤딩(Sharding) 등의 추가 전략이 필요할 수 있다. (단, 현재 트래픽 규모에서는 충분하다고 판단됨)