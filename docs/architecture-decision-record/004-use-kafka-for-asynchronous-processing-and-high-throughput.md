# ADR 004: Kafka를 이용한 비동기 처리 및 처리량 확보

DATE: 2025.05.09

## 상태 (Status)

Accepted

## 맥락 (Context)

Redis를 통해 검증을 통과한 요청이라도, 최종적으로는 RDB에 `IssuedCoupon` 데이터를 `INSERT` 해야 한다.
동기 방식으로 API 서버가 직접 DB에 `INSERT`를 수행할 경우, 트래픽 폭주 시 DB 커넥션 풀이 고갈되어 API 서버 전체가 멈추는 **장애 전파**가 발생할 수 있다.

우리는 사용자의 요청을 유실 없이 안전하게 받으면서 동시에 **DB가 감당 가능한 속도로 처리**해야 하는 요구사항을 가지고 있다.

## 결정 (Decision)

우리는 Apache Kafka를 도입하여 쿠폰 발급 요청(Producer)과 실제 발급 처리(Consumer)를 분리하는 비동기 이벤트 기반 아키텍처를 구성한다.

1. Producer (API Server):
    - 사용자 요청이 유효하면 즉시 Kafka 토픽(`coupon-issue`)에 이벤트를 발행하고, 사용자에게는 "쿠폰 발급 요청이 성공적으로 접수되었습니다."라는 응답을 즉시 반환한다.
    - DB에 직접 접근하지 않으므로 응답 속도가 일정하게 유지된다.

2. Consumer (Worker Server):
    - Kafka 토픽에서 메시지를 가져와(Poling) DB에 저장하는 작업을 수행한다.
    - DB의 부하 상태에 따라 Consumer의 처리 속도나 개수를 조절하여 시스템 안정성을 확보한다.

## 결과 (Consequences)

긍정적 효과 (Pros)
- 높은 처리량: 요청을 큐에 쌓아두고 비동기로 처리하므로, 순간적인 트래픽 피크를 평탄화할 수 있다.
- 결합도 감소: API 서버와 DB 작업 간의 강결합을 끊어내어, DB 장애가 발생해도 사용자 요청 접수는 가능하다.

부정적 효과 및 트레이드오프 (Cons)
- 최종 일관성(Eventual Consistency): 사용자는 발급 요청 직후 내 쿠폰함에서 즉시 쿠폰을 확인하지 못할 수 있다. (수 초 이내의 지연 발생 가능)
- 복잡성 증가: 분산 시스템 환경에서의 트랜잭션 관리, 메시지 유실 방지, 중복 처리 등 고려해야 할 기술적 난이도가 상승한다.


